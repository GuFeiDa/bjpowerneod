<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bjpowernode.crm.workbench.dao.ActivityDao">

    <!--List<Activity> findAllActivity();
        将市场活动的所有者不能显示为ID字段，需要进行关联查询。

        u.name as owner 将user表的name字段封装到Activity实体类的owner属性中

        select * from tbl_activity a , tbl_user u where a.owner = u.id

        查询市场活动列表和关键字查询整合到一个sql语句中
        通过动态sql来进行判断
        如果刷新列表，没有查询条件的
        如果有查询条件，市场活动名称要模糊查询

        大于 greater then  缩写 gt
        小于 less then 缩写 lt
        等于 eq
        大于等于  ge
        小于等于  le
    -->
    <select id="findAllActivity" resultType="Activity">
        select
        a.id,
        u.name as owner,
        a.name,
        a.startDate,
        a.endDate,
        a.cost,
        a.description,
        a.createTime,
        a.createBy
         from tbl_activity a inner join tbl_user u on a.owner = u.id
         <where>
             <if test="name != null and name != ''">
                 and a.name like '%' #{name} '%'
             </if>
             <if test="startDate != null and startDate != ''">
                and a.startDate &gt;= #{startDate}
             </if>
             <if test="endDate != null and endDate != ''">
                 and a.endDate &lt;= #{endDate}
             </if>
         </where>
         and u.id = #{userId}
         limit #{pageNo} , #{pageSize}
    </select>

    <!--void saveActivity(Activity activity);-->
    <insert id="saveActivity" >
        insert into tbl_activity
        (
        id,
        owner,
        name,
        startDate,
        endDate,
        cost,
        description,
        createTime,
        createBy
        )
        values
        (
        #{id},
        #{owner},
        #{name},
        #{startDate},
        #{endDate},
        #{cost},
        #{description},
        #{createTime},
        #{createBy}
        )
    </insert>

    <!--Long findActivityCount(Map<String,Object> paramMap);-->
    <select id="findActivityCount" resultType="java.lang.Long">
        select count(*) from tbl_activity a , tbl_user u
        <where>
            <if test="name != null and name != ''">
                and a.name like '%' #{name} '%'
            </if>
            <if test="startDate != null and startDate != ''">
                and a.startDate &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                and a.endDate &lt;= #{endDate}
            </if>
         and a.owner = u.id and u.id = #{userId}
        </where>
    </select>

    <!--void deleteByIds(String[] activityIds);
        delete from tbl_activity where id in (xx,xx,xx)
    -->
    <delete id="deleteByIds">
        delete from tbl_activity where id in
        <foreach collection="array" item="aId" open="(" close=")" separator=",">
            #{aId}
        </foreach>
    </delete>

    <!--Activity findById(String id);-->
    <select id="findById" resultType="Activity">
        select * from tbl_activity where id = #{id}
    </select>

    <!--void updateById(Activity activity);-->
    <update id="updateById">
        update tbl_activity
        <set>
            <if test="owner != null and owner != ''">
                owner = #{owner},
            </if>
            <if test="name != null and name != ''">
                name = #{name},
            </if>
            <if test="startDate != null and startDate != ''">
                startDate = #{startDate},
            </if>
            <if test="endDate != null and endDate != ''">
                endDate = #{endDate},
            </if>
            <if test="cost != null and cost != ''">
                cost = #{cost},
            </if>
            <if test="description != null and description != ''">
                description = #{description},
            </if>
            <if test="editTime != null and editTime != ''">
                editTime = #{editTime},
            </if>
            <if test="editBy != null and editBy != ''">
                editBy = #{editBy},
            </if>
        </set>
        where id = #{id}
    </update>

    <select id="findAll" resultType="Activity">
        select * from tbl_activity
    </select>

    <!--List<Activity> findByIds(String[] activityIds);-->
    <select id="findByIds" resultType="Activity">
        select * from tbl_activity
        where id in
        <foreach collection="array" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>

    <!--void saveActivityList(List<Activity> aList);-->
    <insert id="saveActivityList">
        insert into tbl_activity
        (
        id,
        name,
        owner,
        startDate,
        endDate,
        cost,
        description,
        createTime,
        createBy
        )
        values
        <foreach collection="list" item="a" separator=",">
            (
            #{a.id},
            #{a.name},
            #{a.owner},
            #{a.startDate},
            #{a.endDate},
            #{a.cost},
            #{a.description},
            #{a.createTime},
            #{a.createBy}
            )
        </foreach>
    </insert>

    <!--根据id查询，市场活动信息，并将所有者进行转换为用户名称-->
    <select id="findActivity" resultType="Activity">
        select
        a.id,
        u.name as owner,
        a.name,
        a.startDate,
        a.endDate,
        a.cost,
        a.description,
        a.createTime,
        a.createBy,
        a.editTime,
        a.editBy
         from tbl_activity a , tbl_user u where a.id = #{id} and u.id = a.owner
    </select>

    <!--List<Activity> findActivityListByClueId(String clueId);-->
    <select id="findActivityListByClueId" resultType="Activity">
        SELECT
        car.id AS relationId,
        a.name,
        a.startDate,
        a.endDate,
        u.name AS OWNER
        FROM
        tbl_activity a , tbl_clue_activity_relation car , tbl_clue c , tbl_user u
        WHERE
        c.id = #{clueId}
        AND
        car.clueId = c.id
        AND
        a.id = car.activityId
        AND
        u.id = a.owner;
    </select>

    <!--List<Activity> findActivityListLike(String activityName);-->
    <select id="findActivityListLike" resultType="Activity">
        select
        a.id,
        a.name,
        a.startDate,
        a.endDate,
        u.name as owner
         from tbl_activity a , tbl_user u where a.name like '%' #{activityName} '%' and u.id = a.owner
    </select>

    <select id="findRelationActivityListLike" resultType="Activity">
        SELECT
        a.id,
        a.startDate,
        a.endDate,
        a.name,
        u.name as owner
        FROM
        tbl_activity a , tbl_user u
        WHERE
        a.id IN
        (
        SELECT activityId FROM tbl_clue_activity_relation WHERE clueId = #{clueId}
        )
        AND
        u.id = a.owner
        AND
        a.name LIKE '%' #{activityName} '%'
    </select>

</mapper>